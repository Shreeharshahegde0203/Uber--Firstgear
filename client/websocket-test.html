<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .log { background: #000; padding: 10px; margin: 10px 0; border: 1px solid #0f0; max-height: 400px; overflow-y: auto; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0af; }
        button { background: #0f0; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0c0; }
        input { padding: 10px; font-size: 16px; margin: 5px; }
    </style>
</head>
<body>
    <h1>🧪 WebSocket Connection Test</h1>
    <div>
        <label>Driver ID: <input type="number" id="driverId" value="7" /></label>
        <button onclick="connectWs()">Connect WebSocket</button>
        <button onclick="disconnectWs()">Disconnect</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    <div class="log" id="log"></div>

    <script>
        let ws = null;
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function connectWs() {
            if (ws) {
                log('⚠️ WebSocket already connected!', 'error');
                return;
            }

            const driverId = document.getElementById('driverId').value;
            const wsUrl = `${WS_URL}/ws/notifications/${driverId}`;
            
            log(`🔌 Connecting to: ${wsUrl}...`, 'info');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('✅ WebSocket CONNECTED!', 'success');
                log('Waiting for ride offers...', 'info');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`📩 RECEIVED: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.type === 'ride_offer_received') {
                    log(`🔔 NEW RIDE OFFER! Ride #${data.ride.id}`, 'success');
                    log(`   From: ${data.ride.start_location}`, 'info');
                    log(`   To: ${data.ride.end_location}`, 'info');
                    log(`   Expires: ${data.ride.expires_at}`, 'info');
                }
            };
            
            ws.onerror = (error) => {
                log(`❌ WebSocket ERROR: ${error}`, 'error');
            };
            
            ws.onclose = (event) => {
                log(`❌ WebSocket CLOSED (Code: ${event.code})`, 'error');
                ws = null;
            };
        }

        function disconnectWs() {
            if (ws) {
                ws.close();
                log('🔌 Disconnected', 'info');
            } else {
                log('⚠️ Not connected', 'error');
            }
        }

        // Auto-connect on load
        window.addEventListener('load', () => {
            log('🚀 WebSocket Test Page Loaded', 'success');
            log('Click "Connect WebSocket" to test connection', 'info');
            log('Then request a ride from rider interface', 'info');
        });
    </script>
</body>
</html>
